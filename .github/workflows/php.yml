# File: .github/workflows/php.yml

name: PHP CI & Auto-formatter

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    # --- بخش اصلاح شده ---
    # دسترسی‌ها باید مستقیماً زیر نام job (build) و در همین سطح قرار بگیرند
    permissions:
      contents: write

    # سیستم‌عامل باید بعد از permissions و در همان سطح باشد
    runs-on: ubuntu-latest
    # -------------------

    steps:
      # مرحله ۱: دریافت کد
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # برای اینکه اکشن بتواند پوش کند، باید توکن را به آن بدهیم
          token: ${{ secrets.GITHUB_TOKEN }}

      # مرحله ۲: راه‌اندازی PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, pdo_mysql

      # مرحله ۳: نصب وابستگی‌ها
      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress

      # مرحله ۴: اصلاح خودکار استایل کد
      - name: Check & Fix Coding Style (PHP-CS-Fixer)
        run: vendor/bin/php-cs-fixer fix --allow-risky=yes

      # مرحله ۵: کامیت خودکار تغییرات
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: Apply PHP-CS-Fixer coding style fixes"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
          commit_author: "${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"

      # مرحله ۶: اجرای تحلیل استاتیک
      - name: Run Static Analysis (PHPStan)
        run: vendor/bin/phpstan analyse --level=2 admin includes